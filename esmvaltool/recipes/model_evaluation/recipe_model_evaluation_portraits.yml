# ESMValTool
#
---
documentation:
  title: Performance metrics plots.
  description: >
    Compare performance of model simulations to a reference dataset.
  authors:
    - lindenlaub_lukas
  maintainer:
    - lindenlaub_lukas
  references:
    - eyring21ipcc


ref_tag: &ref_tag
  reference_for_metric: true
  reference_for_bias: true


preprocessors:
  default: &preproc_default
    regrid:
      target_grid: 2x2
      scheme: linear
    climate_statistics:
      operator: mean
      period: month
  rmse:
    <<: *preproc_default
    distance_metric:
      metric: weighted_rmse
  pearsonr:
    <<: *preproc_default
    distance_metric:
      metric: weighted_pearsonr
  emd:
    <<: *preproc_default
    distance_metric:
      metric: weighted_emd
  rmse_ocean:
    <<: *preproc_default
    mask_below_threshold:
      threshold: 273.15
    mask_landsea:
      mask_out: land
    distance_metric:
      metric: weighted_rmse
  pearsonr_ocean:
    <<: *preproc_default
    mask_below_threshold:
      threshold: 273.15
    mask_landsea:
      mask_out: land
    distance_metric:
      metric: weighted_pearsonr
  emd_ocean:
    <<: *preproc_default
    mask_below_threshold:
      threshold: 273.15
    mask_landsea:
      mask_out: land
    distance_metric:
      metric: weighted_emd
  rmse_land:
    <<: *preproc_default
    mask_landsea:
      mask_out: sea
    distance_metric:
      metric: weighted_rmse
  pearsonr_land:
    <<: *preproc_default
    mask_landsea:
      mask_out: sea
    distance_metric:
      metric: weighted_pearsonr
  emd_land:
    <<: *preproc_default
    mask_landsea:
      mask_out: sea
    distance_metric:
      metric: weighted_emd


VAR_SETTINGS: &var_settings
  project: CMIP6
  mip: Amon
  exp: historical
  ensemble: r1i1p1f1
  grid: gr
  timerange: 2000/2009


datasets:
  - {alias: ACCESS-CM2, dataset: ACCESS-CM2, grid: gn, institute: CSIRO-ARCCSS}
  - {alias: ACCESS-ESM1-5, dataset: ACCESS-ESM1-5, grid: gn, institute: CSIRO}
  - {alias: AWI-CM-1-1-MR, dataset: AWI-CM-1-1-MR, grid: gn}
  - {alias: AWI-ESM-1-1-LR, dataset: AWI-ESM-1-1-LR, grid: gn}
  - {alias: BCC-CSM2-MR, dataset: BCC-CSM2-MR, grid: gn}
  - {alias: BCC-ESM1, dataset: BCC-ESM1, grid: gn}
  - {alias: CAMS-CSM1-0, dataset: CAMS-CSM1-0, grid: gn}
  - {alias: CanESM5, dataset: CanESM5, grid: gn}
  - {alias: CanESM5-CanOE, dataset: CanESM5-CanOE, grid: gn, ensemble: r1i1p2f1}
  - {alias: CESM2, dataset: CESM2, grid: gn}
  - {alias: CESM2-FV2, dataset: CESM2-FV2, grid: gn, institute: NCAR}
  - {alias: CESM2-WACCM, dataset: CESM2-WACCM, grid: gn, institute: NCAR}
  - {alias: CESM2-WACCM-FV2, dataset: CESM2-WACCM-FV2, grid: gn, institute: NCAR}
  - {alias: CIESM, dataset: CIESM}
  - {alias: CNRM-CM6-1, dataset: CNRM-CM6-1, ensemble: r1i1p1f2}
  - {alias: CNRM-CM6-1-HR, dataset: CNRM-CM6-1-HR, ensemble: r1i1p1f2}
  - {alias: CNRM-ESM2-1, dataset: CNRM-ESM2-1, ensemble: r1i1p1f2}
  - {alias: E3SM-1-0, dataset: E3SM-1-0}
  # - {alias: E3SM-1-1, dataset: E3SM-1-1, institute: E3SM-Project}
  - {alias: EC-Earth3-Veg, dataset: EC-Earth3-Veg}
  - {alias: FGOALS-f3-L, dataset: FGOALS-f3-L}
  - {alias: FGOALS-g3, dataset: FGOALS-g3, grid: gn}
  - {alias: GFDL-ESM4, dataset: GFDL-ESM4, grid: gr1}
  - {alias: GISS-E2-1-G, dataset: GISS-E2-1-G, grid: gn}
  - {alias: GISS-E2-1-H, dataset: GISS-E2-1-H, grid: gn}
  - {alias: HadGEM3-GC31-LL, dataset: HadGEM3-GC31-LL, ensemble: r1i1p1f3, grid: gn}
  - {alias: HadGEM3-GC31-MM, dataset: HadGEM3-GC31-MM, ensemble: r1i1p1f3, grid: gn}
  - {alias: INM-CM4-8, dataset: INM-CM4-8, grid: gr1}
  - {alias: INM-CM5-0, dataset: INM-CM5-0, grid: gr1}
  - {alias: IPSL-CM6A-LR, dataset: IPSL-CM6A-LR}
  - {alias: KACE-1-0-G, dataset: KACE-1-0-G}
  - {alias: MIROC-ES2L, dataset: MIROC-ES2L, ensemble: r1i1p1f2, grid: gn}
  - {alias: MPI-ESM-1-2-HAM, dataset: MPI-ESM-1-2-HAM, grid: gn}
  - {alias: MPI-ESM1-2-HR, dataset: MPI-ESM1-2-HR, grid: gn}
  - {alias: MPI-ESM1-2-LR, dataset: MPI-ESM1-2-LR, grid: gn}
  - {alias: MRI-ESM2-0, dataset: MRI-ESM2-0, grid: gn}
  - {alias: NESM3, dataset: NESM3, grid: gn}
  - {alias: NorESM2-LM, dataset: NorESM2-LM, grid: gn, institute: NCC}
  - {alias: NorESM2-MM, dataset: NorESM2-MM, grid: gn, institute: NCC}
  - {alias: SAM0-UNICON, dataset: SAM0-UNICON, grid: gn}
  - {alias: UKESM1-0-LL, dataset: UKESM1-0-LL, ensemble: r1i1p1f2, grid: gn}

ERA5_REF: &era5_ref
  split: Ref1
  additional_datasets:
    - {dataset: ERA5, project: native6, type: reanaly, version: v1, tier: 3, <<: *ref_tag}

diagnostics:
  perfmetrics_rmse:  # seasonal normalized rmse
    variables:
      tas:
        <<: *var_settings
        variable: tas_land
        preprocessor: rmse_land
        <<: *era5_ref
      tas_2:
        <<: *var_settings
        short_name: tas
        preprocessor: rmse_land
        split: Ref2
        variable: tas_land
        additional_datasets:
          - {dataset: HadCRUT5, project: OBS, type: ground,
             version: 5.0.1.0-analysis, tier: 2, <<: *ref_tag}
      lwcre:
        <<: *var_settings
        preprocessor: rmse
        variable: lwcre
        derive: true
        force_derivation: true
        channel: Amon
        split: Ref1
        additional_datasets:
          - {dataset: ISCCP-FH, project: OBS, type: sat, version: v0,
             tier: 2, start_year: 2000, end_year: 2009, <<: *ref_tag}
      lwcre_2:
        <<: *var_settings
        preprocessor: rmse
        short_name: lwcre
        variable: lwcre
        derive: true
        force_derivation: true
        split: Ref2
        channel: Amon
        additional_datasets:
          - {dataset: CERES-EBAF, project: OBS, type: sat, version: Ed4.2,
             tier: 2, start_year: 2001, end_year: 2009, <<: *ref_tag}
      pr: &var_rmse
        variable: pr
        <<: *var_settings
        preprocessor: rmse
        <<: *era5_ref
      pr_2:
        variable: pr
        short_name: pr
        <<: *var_rmse
        split: Ref2
        additional_datasets:
          - {dataset: GPCP-SG, project: OBS, type: atmos, version: 2.3, tier: 2,
             <<: *ref_tag}
      psl:
        variable: psl
        <<: *var_rmse
        <<: *era5_ref
      rlut:
        variable: rlut
        <<: *var_rmse
        <<: *era5_ref
      rlut_2:
        variable: rlut
        short_name: rlut
        <<: *var_rmse
        split: Ref2
        additional_datasets:
          - {dataset: CERES-EBAF, project: OBS, type: sat, version: Ed4.2,
             tier: 2, start_year: 2001, end_year: 2009, <<: *ref_tag}
      rsut:
        <<: *var_rmse
        variable: rsut
        additional_datasets:
          - {dataset: ISCCP-FH, project: OBS, type: sat, version: v0,
             tier: 2, start_year: 2000, end_year: 2009, <<: *ref_tag}
      rsut_2:
        variable: rsut
        short_name: rsut
        <<: *var_rmse
        split: Ref2
        additional_datasets:
          - {dataset: CERES-EBAF, project: OBS, type: sat, version: Ed4.2,
             tier: 2, start_year: 2001, end_year: 2009, <<: *ref_tag}
      swcre:
        variable: swcre
        <<: *var_rmse
        derive: true
        force_derivation: true
        channel: Amon
        additional_datasets:
          - {dataset: ISCCP-FH, project: OBS, type: sat, version: v0,
             tier: 2, start_year: 2000, end_year: 2009, <<: *ref_tag}
      swcre_2:
        variable: swcre
        short_name: swcre
        <<: *var_rmse
        channel: Amon
        derive: true
        force_derivation: true
        split: Ref2
        additional_datasets:
          - {dataset: CERES-EBAF, project: OBS, type: sat, version: Ed4.2,
             tier: 2, start_year: 2001, end_year: 2009, <<: *ref_tag}
      ts:
        variable: sst
        <<: *var_rmse
        <<: *era5_ref
        preprocessor: rmse_ocean
      ts_2:
        variable: sst
        short_name: ts
        <<: *var_rmse
        split: Ref2
        preprocessor: rmse_ocean
        additional_datasets:
          - {dataset: HadISST, project: OBS, type: reanaly, version: 1, tier: 2, <<: *ref_tag}
    scripts:
      portrait:
        script: portrait_plot.py
        x_by: alias
        y_by: variable  # use extra_facet since group and short_name don't work
        group_by: project
        normalize: "centered_median"
        default_split: ERA5
        nan_color: null
        plot_kwargs:
          vmin: -0.3
          vmax: +0.3
        cbar_kwargs:
          label: Relative RMSE
          extend: both
