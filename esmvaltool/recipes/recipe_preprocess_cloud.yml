# ESMValTool
# recipe_preprocess_cloud.yml
---
documentation:
  description: |
    Preprocess cloud properties and cloud controlling factors for causal
    inference study.

  authors:
    - bock_lisa

  title: Preprocess cloud timeseries.

  maintainer:
    - bock_lisa

  projects:
    - cmug


years: &years
  timerange: 200301/200712


ESACCI_CLOUD_datasets: &esacci
        - {dataset: ESACCI-CLOUD, project: OBS6, type: sat, version: v3.0, tier: 2}
ESACCI_WATERVAPOUR_datasets: &esacci_wv
        - {dataset: ESACCI-WATERVAPOUR, project: OBS6, type: sat, version: 3.1, tier: 2}
CERES-EBAF_datasets: &ceres-ebaf
        - {dataset: CERES-EBAF, project: obs4MIPs, level: L3B, tier: 1}
ERA5_datasets: &era5
        - {dataset: ERA5, project: OBS6, type: reanaly, version: v1, tier: 3}


preprocessors:

  south_east_pacific_5x5: &sep_pp_5x5
    extract_region:
      start_latitude: -25.
      end_latitude: -20.
      start_longitude: 280.
      end_longitude: 285.
    mask_landsea:
      mask_out: land

  south_east_pacific: &sep_pp
    extract_region:
      start_latitude: -30.
      end_latitude: -10.
      start_longitude: 265.
      end_longitude: 285.
    mask_landsea:
      mask_out: land

  mean_pp_5x5:
    <<: *sep_pp_5x5
    area_statistics:
       operator: mean

  anomaly_pp_5x5:
    <<: *sep_pp_5x5
    area_statistics:
      operator: mean
    anomalies:
      period: day

  mean_filter_pp_5x5:
    <<: *sep_pp_5x5
    area_statistics:
       operator: mean
    timeseries_filter: &filter
      window: 5  # 3-monthly filter window
      span: 30   # weights computed on the first month
      filter_type: lowpass  # low-pass filter
      filter_stats: mean    # 3-monthly mean lowpass filter

  anomaly_filter_pp_5x5:
    <<: *sep_pp_5x5
    area_statistics:
      operator: mean
    timeseries_filter:
      window: 5  # 3-monthly filter window
      span: 30   # weights computed on the first month
      filter_type: lowpass  # low-pass filter
      filter_stats: mean    # 3-monthly mean lowpass filter
    anomalies:
      period: day

  mean_pp:
    <<: *sep_pp
    regrid: &regrid
      scheme: area_weighted
      target_grid: 5x5      

  anomaly_pp:
    <<: *sep_pp
    regrid:
      scheme: area_weighted
      target_grid: 5x5      
    anomalies:
      period: day

  annual_cycle:
    custom_order: true 
    extract_region:
      start_latitude: -25.
      end_latitude: -20.
      start_longitude: 280.
      end_longitude: 285.
    mask_landsea:
      mask_out: land
    area_statistics:
      operator: mean    
    climate_statistics:
      operator: mean
      period: day
      #rolling_window_statistics:
      #  coordinate: day_of_year
      #  operator: mean
      #  window_length: 30


diagnostics:

  south_east_pacific_clouds:
    description: Create timeseries.
    variables:
      clt: &var
        preprocessor: mean_filter_pp_5x5
        #preprocessor: mean_pp
        mip: day
        frequency: day
        <<: *years
        additional_datasets: *esacci
      clwvi:
        <<: *var
        mip: CFday
      cod:
        <<: *var
        mip: AERday
      ctp:
        <<: *var
        mip: day
      reff:
        <<: *var
        mip: day
      rsdt:
        <<: *var
        mip: Amon
        frequency: mon
        additional_datasets: *ceres-ebaf
      prw:
        <<: *var
        mip: Eday
        additional_datasets: *esacci_wv
      psl: &var2
        <<: *var
        additional_datasets: *era5
      hfss: 
        <<: *var2
      sfcWind: 
        <<: *var2
      ta700: 
        <<: *var2
        mip: CFday 
      ta1000: 
        <<: *var2
      tos:
        <<: *var2
        preprocessor: anomaly_filter_pp_5x5
      wap700:
        <<: *var2
    scripts: 
      timeseries:
        script: causal_clouds_timeseries.py
        compute:
          #- theta700
          #- theta850
          - LTS
            #plot_timeseries:
            #  plot_type: plot
