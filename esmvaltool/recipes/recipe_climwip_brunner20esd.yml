# ESMValTool
# recipe_climwip.yml
---
documentation:
  description: EUCP ClimWIP

  authors:
    - kalverla_peter
    - smeets_stef
    - brunner_lukas
    - camphuijsen_jaro
    - lorenz_ruth

  maintainer:
    - kalverla_peter
    - smeets_stef
    - brunner_lukas
    - lorenz_ruth

  references:
    - brunner2019
    - lorenz2018
    - knutti2017

datasets: &model_data
  - {project: CMIP6, exp: [historical, ssp585], dataset: ACCESS-CM2, ensemble: r(1:3)i1p1f1, grid: gn}
  - {project: CMIP6, exp: [historical, ssp585], dataset: ACCESS-ESM1-5, ensemble: r(1:10)i1p1f1, grid: gn}
  - {project: CMIP6, exp: [historical, ssp585], dataset: AWI-CM-1-1-MR, ensemble: r1i1p1f1, grid: gn}
  - {project: CMIP6, exp: [historical, ssp585], dataset: BCC-CSM2-MR, ensemble: r1i1p1f1, grid: gn}
  # ... add more models
  - {project: CMIP6, exp: [historical, ssp585], dataset: UKESM1-0-LL, ensemble: r(1:4)i1p1f2, grid: gn}
  - {project: CMIP6, exp: [historical, ssp585], dataset: UKESM1-0-LL, ensemble: r8i1p1f2, grid: gn}

obs_data: &obs_data  # for climwip performance metrics
  - {dataset: ERA5, project: native6, type: reanaly, version: '1', tier: 3}

preprocessors:
  climwip_general: &general
    regrid:
      target_grid: 2.5x2.5
      scheme: linear

  climatological_mean:
    <<: *general
    climate_statistics:
      operator: mean

  detrended_std:
    custom_order: true
    <<: *general
    annual_statistics:
      operator: mean
    detrend:
      dimension: time
      method: linear
    climate_statistics:
      operator: std_dev

  annual_trend:
    <<: *general
    annual_statistics:
      operator: mean
    linear_trend:
      coordinate: time
    convert_units:
      units: "K year-1"

  global_mean:
    <<: *general
    climate_statistics:
      operator: mean
    area_statistics:
      operator: mean

  temperature_anomalies:
    custom_order: true
    area_statistics:
      operator: mean
    annual_statistics:
      operator: mean
    anomalies:
      period: full
      reference:
        start_year: 1995
        start_month: 1
        start_day: 1
        end_year: 2014
        end_month: 12
        end_day: 31
      standardize: false

diagnostics:
  # if local anomalies are needed as predictors they need to be calculated first
  calculate_local_anomalies:
    variables:
      tas_CLIM: &performance_settings
        short_name: tas
        start_year: 1995
        end_year: 2014
        mip: Amon
        preprocessor: climatological_mean
        additional_datasets: *obs_data
      tas_GLOBAL:
        <<: *performance_settings
        preprocessor: global_mean
      psl_CLIM:
        <<: *performance_settings
        short_name: psl
        preprocessor: climatological_mean
      psl_GLOBAL:
        <<: *performance_settings
        short_name: psl
        preprocessor: global_mean
    scripts:
      local_anomalies:
        script: weighting/calculate_difference_variable_group.py
        obs_data: native6


  calculate_weights_climwip:
    variables:
      tas_CLIM_i: &independence_settings
        short_name: tas
        start_year: 1995
        end_year: 2014
        mip: Amon
        preprocessor: climatological_mean
        additional_datasets: *obs_data
      psl_CLIM_i:
        <<: *independence_settings
        short_name: psl
      tas_STD:
        <<: *performance_settings
        preprocessor: detrended_std
      psl_STD:
        <<: *performance_settings
        short_name: psl
        preprocessor: detrended_std
      tas_TREND:
        <<: *performance_settings
        preprocessor: annual_trend

    scripts:
      climwip:
        script: weighting/climwip/main.py
        obs_data: native6
        ancestors: [calculate_local_anomalies/local_anomalies,
                    tas_CLIM_i, psl_CLIM_i, tas_STD, psl_STD, tas_TREND]
        combine_ensemble_members: true
        performance_sigma: 0.43
        performance_contributions:
          tas_ANOM: 1
          tas_STD: 1
          psl_ANOM: 1
          psl_STD: 1
          tas_TREND: 2
        independence_sigma: 0.54
        independence_contributions:
          tas_CLIM_i: 1
          psl_CLIM_i: 1

  weighted_temperature_graph:
    variables:
      tas:
        start_year: 1960
        end_year: 2100
        mip: Amon
        preprocessor: temperature_anomalies
    scripts:
      weighted_temperature_graph:
        script: weighting/weighted_temperature_graph.py
        ancestors: [calculate_weights_climwip/climwip, tas]
        weights: 'weights.nc'

  weighted_temperature_map_box:
    variables:
      tas: &map_settings
        short_name: tas
        start_year: 2081
        end_year: 2100
        mip: Amon
        preprocessor: climatological_mean
      tas_reference:
        <<: *map_settings
        start_year: 1995
        end_year: 2014
    scripts:
      weighted_temperature_map:
        script: weighting/weighted_temperature_map.py
        ancestors: [calculate_weights_climwip/climwip, tas, tas_reference]
        weights: 'weights.nc'
        # optional arguments
        model_aggregation: mean  # [ mean (default) | median | integer in (0, 100) ]
        xticks: [0, 10, 20, 30, 40]  # if not given ticks will be set automatically
        yticks: [30, 40, 50, 60, 70, 80]
