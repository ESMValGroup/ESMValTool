# ESMValTool
# 
---
documentation:
  title: Performance metrics plots.
  description: >
    Compare performance of model simulations to a reference dataset.
  authors:
    - ruhe_lukas
    # - cammarano_diego
  maintainer:
    - ruhe_lukas
  references:
    - eyring21ipcc


preprocessors:
  default: &default_preproc
    custom_order: true
    regrid:
      target_grid: 3x3
      scheme: nearest
      # for icon:
      # scheme:
      #   reference: esmf_regrid.schemes:ESMFAreaWeighted
    regrid_time:
      calendar: standard
      frequency: mon
    distance_metric:
      metric: pearsonr
  rmse:
    <<: *default_preproc
    distance_metric:
      metric: rmse


cmip6_default: &cmip6
  grid: gn
  ensemble: r1i1p1f1
  project: CMIP6
  timerange: '1990/1992'


cmip6_examples: &cmip6_examples
  - {<<: *cmip6, dataset: MRI-ESM2-0}
  - {<<: *cmip6, dataset: NESM3}
  - {<<: *cmip6, dataset: NorCPM1, institute: NCC, ensemble: r10i1p1f1}
  - {<<: *cmip6, dataset: NorESM2-LM, institute: NCC}
  - {<<: *cmip6, dataset: NorESM2-MM, institute: NCC}
  - {<<: *cmip6, dataset: SAM0-UNICON}
  - {<<: *cmip6, dataset: TaiESM1}
  - {<<: *cmip6, dataset: UKESM1-0-LL, ensemble: r1i1p1f2}

cmip6_remaining: &cmip6_remaining
  - {<<: *cmip6, dataset: ACCESS-CM2}
  - {<<: *cmip6, dataset: ACCESS-ESM1-5, institute: CSIRO}
  - {<<: *cmip6, dataset: AWI-CM-1-1-MR}
  - {<<: *cmip6, dataset: AWI-ESM-1-1-LR}
  - {<<: *cmip6, dataset: CESM2-FV2, institute: NCAR}
  - {<<: *cmip6, dataset: CESM2-WACCM-FV2, institute: NCAR}
  - {<<: *cmip6, dataset: CESM2-WACCM, institute: NCAR}
  - {<<: *cmip6, dataset: CIESM, grid: gr}
  - {<<: *cmip6, dataset: CMCC-CM2-HR4}
  - {<<: *cmip6, dataset: CMCC-CM2-SR5}
  - {<<: *cmip6, dataset: CMCC-ESM2}
  - {<<: *cmip6, dataset: CNRM-CM6-1-HR, ensemble: r1i1p1f2, grid: gr}
  - {<<: *cmip6, dataset: CNRM-CM6-1, ensemble: r1i1p1f2, grid: gr}
  - {<<: *cmip6, dataset: CNRM-ESM2-1, ensemble: r1i1p1f2, grid: gr}
  - {<<: *cmip6, dataset: E3SM-1-0, grid: gr}
  - {<<: *cmip6, dataset: E3SM-1-1-ECA, institute: E3SM-Project, grid: gr}
  - {<<: *cmip6, dataset: E3SM-1-1, institute: E3SM-Project, grid: gr}
  - {<<: *cmip6, dataset: EC-Earth3-AerChem, grid: gr}
  - {<<: *cmip6, dataset: EC-Earth3-CC, grid: gr}
  - {<<: *cmip6, dataset: EC-Earth3-Veg-LR, grid: gr}
  - {<<: *cmip6, dataset: EC-Earth3-Veg, grid: gr}
  - {<<: *cmip6, dataset: EC-Earth3, grid: gr}
  - {<<: *cmip6, dataset: FGOALS-f3-L, grid: gr}
  - {<<: *cmip6, dataset: FGOALS-g3}
  - {<<: *cmip6, dataset: GFDL-CM4, grid: gr1}
  - {<<: *cmip6, dataset: GFDL-ESM4, grid: gr1}
  - {<<: *cmip6, dataset: GISS-E2-1-G}
  - {<<: *cmip6, dataset: GISS-E2-1-H}
  - {<<: *cmip6, dataset: HadGEM3-GC31-LL, ensemble: r1i1p1f3}
  - {<<: *cmip6, dataset: HadGEM3-GC31-MM, ensemble: r1i1p1f3}
  - {<<: *cmip6, dataset: IITM-ESM}
  - {<<: *cmip6, dataset: INM-CM4-8, grid: gr1}
  - {<<: *cmip6, dataset: INM-CM5-0, grid: gr1}
  - {<<: *cmip6, dataset: IPSL-CM6A-LR, grid: gr}
  - {<<: *cmip6, dataset: KIOST-ESM, grid: gr1}
  - {<<: *cmip6, dataset: MIROC-ES2L, ensemble: r1i1p1f2}
  - {<<: *cmip6, dataset: MIROC6}
  - {<<: *cmip6, dataset: MPI-ESM-1-2-HAM}
  - {<<: *cmip6, dataset: MPI-ESM1-2-HR}
  - {<<: *cmip6, dataset: MPI-ESM1-2-LR}

datasets:
  *cmip6_examples
  # ICON
  # - {project: ICON, dataset: ICON, exp: icon-2.6.1_atm_amip_R2B4_r1v1i1p1l1f1, timerange: '19900101/19930101'}

  #   # grid wrong? missing data
  #   # - {<<: *cmip6, dataset: MCM-UA-1-0}
  #   # - {<<: *cmip6, dataset: GISS-E2-1-G-CC}
  #   # - {<<: *cmip6, dataset: IPSL-CM5A2-INCA, grid: gr}
  #   # - {<<: *cmip6, dataset: KACE-1-0-G, grid: gr}


diagnostics:
  simple:
    variables: &simple_variables
      pr: &var_default
        preprocessor: default
        mip: Amon
        exp: historical
        additional_datasets: &ref
          # - {dataset: ERA5, project: native6, type: reanaly, version: v1, tier: 3, reference_for_metric: true}
          - {<<: *cmip6, dataset: BCC-ESM1, reference_for_metric: true, timerange: 1990/1992}
      tas:
        <<: *var_default
      ps:
        <<: *var_default
      clt:
        <<: *var_default
    scripts:
      perfmetrics:
        script: perfmetrics/main.py
        y_by: variable_group

  complex:
    description: >
      A more complex example with extra variables to support different reference datasets, 
      groups for datasets and some plot customization.
    variables:
      pr: 
        <<: *var_default
        y_label: Precipitation
      pr_vs_access: &var_default_ref2
        <<: *var_default
        short_name: pr
        split: "ACCESS"
        y_label: Precipitation
        additional_datasets: &ref_access
          - {<<: *cmip6, dataset: ACCESS-ESM1-5, institute: CSIRO, reference_for_metric: true}
      pr_vs_era:
        <<: *var_default
        short_name: pr
        split: "ERA5"
        y_label: Precipitation
        additional_datasets: &ref_era
          - {dataset: ERA5, project: native6, type: reanaly, version: v1, tier: 3, timerange: 1990/1992, reference_for_metric: true}
      tas:
        <<: *var_default
        y_label: Temperature
        # additional_datasets:
        #     - {dataset: NCEP-NCAR-R1, project: OBS6, type: reanaly, version: 1, tier: 2}
      tas_vs_access:
        short_name: tas
        <<: *var_default_ref2
        y_label: Temperature
      rlut: 
        <<: *var_default
        y_label: "LW radiation out"

      ps:
        <<: *var_default
        y_label: "Surface pressure"
      # sfcWind:
      #   <<: *var_default
      clt:
        <<: *var_default
        y_label: "Cloud cover"
      clt_vs_esacci:
        <<: *var_default
        short_name: clt
        split: "ESACCI"
        y_label: "Cloud cover"
        additional_datasets: 
          - {reference_for_metric: true, dataset: ESACCI-CLOUD, project: OBS, type: sat, version: AVHRR-fv3.0, tier: 2, timerange: '1990/1992'}
      psl:
        <<: *var_default
        y_label: "Sea level pressure"


    additional_datasets:
      # - {dataset: ERA5, project: native6, type: reanaly, 
      #   version: v1, tier: 3, reference_for_metric: true}
      - {<<: *cmip6, dataset: MPI-ESM-MR, type: exp, project: CMIP5, exp: historical, ensemble: r1i1p1}

    scripts:
      perfmetrics:
        script: perfmetrics/main.py
        x_by: dataset
        y_by: y_label
        # split_by is the 'split' extra facet by default (set in variables)
        group_by: project
        additional_datasets:
          - {<<: *cmip6, dataset: MPI-ESM-MR, type: exp, project: CMIP5, exp: historical, ensemble: r1i1p1}
        plot_kwargs:
          vmin: 0.0
          vmax: 0.6
        cbar_kwargs:
          label: "Pearson correlation coefficient"
          ticks: [0, 0.3, 0.6]
          extend: both
        cmap: "Reds"
  metrics:
    variables:
      pr:
        <<: *var_default
        y_label: "Precipitation"
      pr_rmse:
        short_name: ps
        split: "RMSE"
        y_label: "Precipitation"
        <<: *var_default
        preprocessor: rmse
      tas:
        <<: *var_default
        y_label: "Temperature"
      tas_rmse:
        short_name: tas
        split: "RMSE"
        y_label: "Temperature"  # extra_facet to share y tick
        <<: *var_default
        preprocessor: rmse
      clt:
        <<: *var_default
        y_label: "Cloud cover"
      clt_rmse:
        short_name: clt
        y_label: "Cloud cover"
        split: "RMSE"
        <<: *var_default
        preprocessor: rmse
    scripts:
      perfmetrics:
        script: perfmetrics/main.py
        y_by: y_label
        plot_kwargs:
          vmin: 0
          vmax: 1.0