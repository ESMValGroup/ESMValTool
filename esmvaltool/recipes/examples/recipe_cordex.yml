# ESMValTool
# recipe_python.yml
#
# See https://docs.esmvaltool.org/en/latest/recipes/recipe_examples.html
# for a description of this recipe.
#
# See https://docs.esmvaltool.org/projects/esmvalcore/en/latest/recipe/overview.html
# for a description of the recipe format.
---
documentation:
  description: |
    Example recipe that plots a map and timeseries of temperature
    from a CORDEX Europe Model.

  title: Recipe that runs an example diagnostic for CORDEX.

  authors :
    - savage_nick

  maintainer:
    - savage_nick

datasets:
  - {institute: SMHI, driver: NCC-NorESM1-M, dataset: SMHI-RCA4, exp: historical, project: CORDEX, ensemble: r1i1p1, mip: mon, rcm_version: v1, domain: EUR-11}
  - {institute: ICTP, driver: NCC-NorESM1-M, dataset: ICTP-RegCM4-6, exp: historical, project: CORDEX, ensemble: r1i1p1, mip: mon, rcm_version: v1, domain: EUR-11}

preprocessors:
  # See https://docs.esmvaltool.org/projects/esmvalcore/en/latest/recipe/preprocessor.html
  # for a description of the preprocessor functions.

  to_degrees_c:
    convert_units:
      units: degrees_C

  annual_mean_amsterdam:
    extract_location:
      location: Amsterdam
      scheme: linear
    # Fails with 
    # ValueError: Multi-model statistics failed to merge input cubes into a single array:
    # 0: air_temperature / (degrees_C)       (time: 36; projection_y_coordinate: 1; projection_x_coordinate: 1)
    # 1: air_temperature / (degrees_C)       (time: 36; grid_latitude: 1; grid_longitude: 1)
    #   Coordinates in cube.dim_coords differ: grid_latitude, grid_longitude, projection_x_coordinate, projection_y_coordinate.
    #   Coordinates in cube.aux_coords (non-scalar) differ: latitude, longitude.
    # multi_model_statistics:
    #   statistics:
    #     - mean
    #   span: overlap
    annual_statistics:
      operator: mean
    convert_units:
      units: degrees_C

  domain_mean_global:
    area_statistics:
      operator: mean
    annual_statistics:
      operator: mean
    convert_units:
      units: degrees_C


diagnostics:

  map:
    description: Map of European temperature in January 2000.
    themes:
      - phys
    realms:
      - atmos
    variables:
      tas:
        mip: Amon
        preprocessor: to_degrees_c
        timerange: 2000/P1M
        caption: |
          Domain map of {long_name} in January 2000 according to {driver}-{dataset}.
    scripts:
      script1:
        script: examples/diagnostic.py
        quickplot:
          plot_type: pcolormesh
          cmap: Reds

  timeseries:
    description: Annual mean temperature in Amsterdam and domain mean since 1970.
    themes:
      - phys
    realms:
      - atmos
    variables:
      tas_amsterdam:
        short_name: tas
        mip: Amon
        preprocessor: annual_mean_amsterdam
        timerange: 1970/2005
        caption: Annual mean {long_name} in Amsterdam according to {driver}-{dataset}.
      # the following gives the error:
      # ERROR   Unable to load CMOR table (project) 'CORDEX' for variable 'areacella' with mip 'mon'
      # tas_domain:
      #   short_name: tas
      #   mip: Amon
      #   preprocessor: domain_mean_global
      #   timerange: 1970/2005
      #   caption: Annual global mean {long_name} according to {driver}-{dataset}.
    scripts:
      script1:
        script: examples/diagnostic.py
        quickplot:
          plot_type: plot
  