# ESMValTool
# recipe_event_attribution_swbc_rx2day.yml
---
documentation:

  title: Event attribution of the 2021 floods in South West BC. 

  description: This is a recipe for event attribution of the 2021
               Pacific Northwest heat wave in South West British Columbia.
               The observational return periods are calculated from 
               ERA5 and the probability of the event is compared in 
               different climates based on CMIP6 data. 

  authors:
    - malinina_elizaveta

preprocessors:
  preproc_rx2day: &prep_rx2day
    custom_order: True
    regrid:
      target_grid: 0.5x0.5
      lon_offset: 0.25
      lat_offset: 0.25
      scheme: linear    
    extract_region:
      start_longitude: -125.0
      end_longitude: -120.5
      start_latitude: 48.25
      end_latitude: 50.25
    area_statistics:
      operator: mean
    rolling_window_statistics:
      coordinate: time
      operator: sum
      window_length: 2
    annual_statistics:
      operator: max
  
  preproc_ano:
    <<: *prep_rx2day
    climate_statistics: 
      operator: mean
      period: full

  preproc_era_abs: &prep_era_abs
    custom_order: True 
    extract_region:
      start_longitude: -125.0
      end_longitude: -120.5
      start_latitude: 48.25
      end_latitude: 50.25
    area_statistics:
      operator: mean
    rolling_window_statistics:
      coordinate: time
      operator: sum
      window_length: 2
    annual_statistics:
      operator: max
    convert_units:
      units: mm day-1

datasets_pr: &datasets_pr
  - {dataset: ACCESS-ESM1-5, ensemble: "r(1:15)i1p1f1", mip: day, grid: gn} 
  - {dataset: ACCESS-ESM1-5, ensemble: "r(21:25)i1p1f1", mip: day, grid: gn}
  - {dataset: ACCESS-ESM1-5, ensemble: "r(27:40)i1p1f1", mip: day, grid: gn}
  - {dataset: ACCESS-CM2, ensemble: "r(1:5)i1p1f1", mip: day, grid: gn} 
  - {dataset: BCC-CSM2-MR, ensemble: r1i1p1f1, mip: day, grid: gn}
  - {dataset: CanESM5, ensemble: "r(1:25)i1p1f1", mip: day, grid: gn} 
  - {dataset: CanESM5, ensemble: "r(1:25)i1p2f1", mip: day, grid: gn}
  # - {dataset: CMCC-ESM2, ensemble: r1i1p1f1, mip: day, grid: gn}
  # - {dataset: CMCC-CM2-SR5, ensemble: r1i1p1f1, mip: day, grid: gn}
  - {dataset: CNRM-CM6-1, ensemble: r1i1p1f2, mip: day, grid: gr}
  - {dataset: CNRM-ESM2-1, ensemble: r1i1p1f2, mip: day, grid: gr}
  - {dataset: GFDL-ESM4, institute: NOAA-GFDL, ensemble: r1i1p1f1, mip: day, grid: gr1 }
  - {dataset: GFDL-CM4, institute: NOAA-GFDL, ensemble: r1i1p1f1, mip: day, grid: gr2 }
  - {dataset: HadGEM3-GC31-LL, ensemble: r1i1p1f3, mip: day, grid: gn }
  - {dataset: INM-CM5-0, ensemble: r1i1p1f1, mip: day, grid: gr1 }
  - {dataset: INM-CM4-8, ensemble: r1i1p1f1, mip: day, grid: gr1 }
  - {dataset: IPSL-CM6A-LR, ensemble: "r(1:6)i1p1f1", mip: day, grid: gr }
  - {dataset: IPSL-CM6A-LR, ensemble: "r(10:11)i1p1f1", mip: day, grid: gr }
  - {dataset: IPSL-CM6A-LR, ensemble: r14i1p1f1, mip: day, grid: gr }
  - {dataset: IPSL-CM6A-LR, ensemble: r22i1p1f1, mip: day, grid: gr }
  - {dataset: KACE-1-0-G, ensemble: "r(1:3)i1p1f1", mip: day, grid: gr } 
  - {dataset: MIROC6, ensemble: "r(1:3)i1p1f1", mip: day, grid: gn}
  - {dataset: MIROC6, ensemble: "r(21:37)i1p1f1", mip: day, grid: gn}
  - {dataset: MIROC6, ensemble: "r(47:50)i1p1f1", mip: day, grid: gn}
  - {dataset: MPI-ESM1-2-LR, ensemble: "r(1:3)i1p1f1", mip: day, grid: gn} 
  - {dataset: MPI-ESM1-2-LR, ensemble: "r(5:10)i1p1f1", mip: day, grid: gn}
  - {dataset: MRI-ESM2-0, ensemble: "r(1:5)i1p1f1", mip: day, grid: gn}
  - {dataset: NorESM2-LM, ensemble: r1i1p1f1, mip: day, grid: gn}
  # - {dataset: NorESM2-MM, ensemble: "r(1:2)i1p1f1", mip: day, grid: gn}
  - {dataset: NorESM2-MM, ensemble: r1i1p1f1, mip: day, grid: gn}
  - {dataset: TaiESM1, ensemble: r1i1p1f1, mip: day, grid: gn}
  - {dataset: UKESM1-0-LL, ensemble: "r(1:4)i1p1f2", mip: day, grid: gn}
  - {dataset: UKESM1-0-LL, ensemble: r8i1p1f2, mip: day, grid: gn} 
  - {dataset: UKESM1-0-LL, ensemble: "r(10:12)i1p1f2", mip: day, grid: gn} 
  - {dataset: UKESM1-0-LL, ensemble: "r(16:19)i1p1f2", mip: day, grid: gn} 

dataset_era: &dataset_era
  - {dataset: ERA5, project: OBS6, type: reanaly, version: v1, tier: 3}

diagnostics:
  observations:
    description: Calculate event statistic in the observational data
                 for a selected year and plot the observational figure. 
                 Similar to figs 3 and 4 and observational info in tab 2 
                 in Malinina&Gillet (2024). 
    variables:     
      obs_data:
        short_name: pr
        start_year: 1950
        end_year: 2021
        mip: day
        preprocessor: preproc_era_ano 
        additional_datasets: *dataset_era         
    scripts:
      absolute:
        script: eccc_extremes/observational_return_periods.py
        CI_quantiles: [5, 95] # percentiles for the confidence interval, mandatory parameter
        mpl_style: malinina24 # optional parameter, defines plot style
        color_style: malinina24 # optional but hightly recommended, otherwise all lines black
        yblock: 1 # (optional) determines how many years in block should be pooled in boostrap, default 1
        region: SWBC # needed for the figure title
        var_label: RX2day # needed for axis name
        analysis_year: 2021 # optional parameter, year for which analysis should be done
        smooth_covariate_years: 4 # optional parameter if the covariate data should be smoothed
        covariate_dataset: ERA5 # optional parameter, needed if the extreme dataset doesn't have its own covariate
        bootstrap_seed: 501 # seed to start sequence for bootstrap (optional, default 1)
        units: mm # optional parameter for the labeling
      observations:
        script: eccc_extremes/observational_return_periods.py
        CI_quantiles: [5, 95] # percentiles for the confidence interval, mandatory parameter
        mpl_style: malinina24 # optional parameter, defines plot style
        color_style: malinina24 # optional but hightly recommended, otherwise all lines black
        yblock: 5 # (optional) determines how many years in block should be pooled in boostrap, default 1
        region: SWBC # needed for the figure title
        var_label: RX2day # needed for axis name
        analysis_year: 2021 # optional parameter, year for which analysis should be done
        smooth_covariate_years: 4 # optional parameter if the covariate data should be smoothed
        covariate_dataset: ERA5 # optional parameter, needed if the extreme dataset doesn't have its own covariate
        bootstrap_seed: 501 # seed to start sequence for bootstrap (optional, default 1)
        units: mm # optional parameter for the labeling
        anomaly: #optional parameter if anomalies calculaetd in the diagnostic
          type: ratio # options: anomaly and ratio
          period: [1950, 1969]
  models:
    description: Calculate the event probability in different climates 
                 for an event selected in the observations diagnostic. 
                 Similar to fig 9 and inputs in tab 2 and 3
                 in Malinina&Gillet (2024). 
    variables:
      factual:
        short_name: pr
        exp: [historical, ssp245]
        start_year: 2011
        end_year: 2030
        project: CMIP6
        mip: day
        preprocessor: preproc_rx2day
        additional_datasets: *datasets_pr
      ssp245: 
        short_name: pr
        exp: ssp245
        start_year: 2081
        end_year: 2100
        project: CMIP6
        mip: day
        preprocessor: preproc_rx2day
        additional_datasets: *datasets_pr        
      nat: 
        short_name: pr
        exp: historical
        start_year: 1850
        end_year: 1900
        project: CMIP6
        mip: day
        preprocessor: preproc_rx2day
        additional_datasets: *datasets_pr
      anomaly:
        short_name: pr
        exp: historical
        start_year: 1950
        end_year: 1969
        project: CMIP6
        mip: day
        preprocessor: preproc_ano
        additional_datasets: *datasets_pr
    scripts:
      models:
        script: eccc_extremes/model_analysis_event_attribution.py
        ancestors: [observations/observations, factual, ssp245, nat, anomaly]
        obs_ref_dataset: ERA5 # the dataset name that will be used for event definition, mandatory parameter
        CI_quantiles: [5, 95] # percentiles for the confidence interval, mandatory parameter
        mpl_style: malinina24 # optional parameter, defines plot style
        color_style: malinina24 # optional but hightly recommended, otherwise all lines black
        obs_gev: stationary # which GEV stats from observations to use options: stationary (default), nonstationary
        individual_models: False # do the output for sigle models (true) or multi-model ensemble (false, default)
        anomaly_type: ratio # options: anomaly (default) and ratio
        yblock: 5 # (optional) determines how many years in block should be pooled in boostrap
        initial_conditions: False # use initial conditions for the GEV fit
        model_weighting: False # determines, if each realisation gets a weight of 1 (false) or 1/number of relisation
        event_definition: strength # options: strength (default) magnitude of the event from obs, rarity: uses return period
        # from obs and then finds the event of the same rarity in the factual climate
        region: BC # needed for the figure title
        var_label: RX2day # needed for axis name
        units: mm # optional parameter for the labelling
        bootstrap_seed: 501 # seed to start sequence for bootstrap (optional)
