# ESMValTool
# recipe_event_attribution_fiona.yml
---
documentation:

  title: Event attribution of the 2022 extratropical storm Fiona.

  description: This is a recipe for event attribution of the 2022
               extratropical storm Fiona in Atlantic Canada.
               The observational return periods are calculated from
               ERA5 and the probability of the event is compared in
               different climates based on CMIP6 data.

  authors:
    - malinina_elizaveta

preprocessors:
  preproc_wxx: &prep_wxx
    custom_order: True
    extract_season:
      season: JJASO
    extract_shape:
      shapefile: pei_ns_nb_newfoundland.shp
      method: contains
      crop: True
    area_statistics:
      operator: max
    annual_statistics:
      operator: max

  preproc_era_gsat:
    custom_order: True
    area_statistics:
      operator: mean
    annual_statistics:
      operator: mean
    anomalies:
      period: full
      reference:
        start_year: 1950
        start_month: 1
        start_day: 1
        end_year: 1979
        end_month: 12
        end_day: 31

datasets_highresmip: &datasets_highresmip
  - {dataset: CMCC-CM2-VHR4, ensemble: r1i1p1f1, grid: gn} # res 0.25d
  - {dataset: CNRM-CM6-1-HR, ensemble: "r(1:10)i1p1f2", grid: gr} # res 0.25d
  - {dataset: EC-Earth3P-HR, ensemble: r(2:3)i1p1f1, grid: gr} # res 40km
  - {dataset: NICAM16-8S, ensemble: r1i1p1f1, grid: gr} # res 28km
  - {dataset: HadGEM3-GC31-HM, ensemble: "r1i(2:3)p1f1", grid: gn} # res 0.23° × 0.35°
  - {dataset: MRI-AGCM3-2-H, ensemble: r1i1p1f1, grid: gn} # res 0.19° × 0.19°
  - {dataset: MRI-AGCM3-2-S, ensemble: r1i1p1f1, grid: gn} # res 0.56° × 0.56°
  - {dataset: MPI-ESM1-2-XR, ensemble: r1i1p1f1, grid: gn} #  res 0.56

dataset_era: &dataset_era
  - {dataset: ERA5, type: reanaly, version: v1, tier: 3}

diagnostics:
  observations:
    description: Calculate event statistic in the observational data
                 for a selected year and plot the observational figure.
                 Similar to figs 3 and 4 and observational info in tab 2
                 in Malinina&Gillet (2024).
    variables:
      obs_data:
        short_name: sfcWind
        start_year: 1940
        end_year: 2022
        project: OBS6
        mip: E1hr
        preprocessor: preproc_wxx
        additional_datasets: *dataset_era
      obs_covariate:
        short_name: tas
        project: OBS6
        start_year: 1940
        end_year: 2022
        mip: Amon
        preprocessor: preproc_era_gsat
        additional_datasets: *dataset_era
    scripts:
      observations:
        script: eccc_extremes/observational_return_periods.py
        CI_quantiles: [5, 95] # percentiles for the confidence interval, mandatory parameter
        mpl_style: malinina24 # optional parameter, defines plot style
        color_style: malinina24 # optional but hightly recommended, otherwise all lines black
        yblock: 1 # (optional) determines how many years in block should be pooled in boostrap, default 1
        region: Atl.Canada # needed for the figure title
        var_label: wind_speed # needed for axis name
        analysis_year: 2022 # optional parameter, year for which analysis should be done
        smooth_covariate_years: 4 # optional parameter if the covariate data should be smoothed
        covariate_dataset: ERA5 # optional parameter, needed if the extreme dataset doesn't have its own covariate
        bootstrap_seed: 501 # seed to start sequence for bootstrap (optional, default 1)
        units: '' # optional parameter for the labeling
        anomaly: #optional parameter if anomalies calculaetd in the diagnostic
          type: standardized_anomaly # options: anomaly, standardized_anomaly and ratio
          period: [1950, 1979]
  models:
    description: Calculate the event probability in different climates
                 for an event selected in the observations diagnostic.
                 Similar to fig 9 and inputs in tab 2 and 3
                 in Malinina&Gillet (2024).
    variables:
      factual:
        short_name: sfcWindmax
        exp: [highresSST-present, highresSST-future]
        start_year: 2008
        end_year: 2037
        project: CMIP6
        mip: day
        preprocessor: preproc_wxx
        additional_datasets: *datasets_highresmip
      nat:
        short_name: sfcWindmax
        exp: highresSST-present
        start_year: 1950
        end_year: 1979
        project: CMIP6
        mip: day
        preprocessor: preproc_wxx
        additional_datasets: *datasets_highresmip
      anomaly:
        short_name: sfcWindmax
        exp: highresSST-present
        start_year: 1950
        end_year: 1979
        project: CMIP6
        mip: day
        preprocessor: preproc_wxx
        additional_datasets: *datasets_highresmip
    scripts:
      models_unwght:
        script: eccc_extremes/model_analysis_event_attribution.py
        ancestors: [observations/observations, factual, nat, anomaly]
        obs_ref_dataset: ERA5 # the dataset name that will be used for event definition, mandatory parameter
        CI_quantiles: [5, 95] # percentiles for the confidence interval, mandatory parameter
        mpl_style: malinina24 # optional parameter, defines plot style
        color_style: malinina24 # optional but hightly recommended, otherwise all lines black
        obs_gev: stationary # which GEV stats from observations to use options: stationary (default), nonstationary
        individual_models: False # do the output for sigle models (true) or multi-model ensemble (false, default)
        anomaly_type: standardized_anomaly # options: anomaly (default), standardized_anomaly and ratio
        yblock: 1 # (optional) determines how many years in block should be pooled in boostrap
        initial_conditions: False # use initial conditions for the GEV fit
        model_weighting: False # determines, if each realisation gets a weight of 1 (false) or 1/number of relisation
        event_definition: strength # options: strength (default) magnitude of the event from obs, rarity: uses return period
        # from obs and then finds the event of the same rarity in the factual climate
        region: Atl.Canada # needed for the figure title
        var_label: wind_speed # needed for axis name
        units: '' # optional parameter for the labelling
        bootstrap_seed: 501 # seed to start sequence for bootstrap (optional)
      models_wght:
        script: eccc_extremes/model_analysis_event_attribution.py
        ancestors: [observations/observations, factual, nat, anomaly]
        obs_ref_dataset: ERA5 # the dataset name that will be used for event definition, mandatory parameter
        CI_quantiles: [5, 95] # percentiles for the confidence interval, mandatory parameter
        mpl_style: malinina24 # optional parameter, defines plot style
        color_style: malinina24 # optional but hightly recommended, otherwise all lines black
        obs_gev: stationary # which GEV stats from observations to use options: stationary (default), nonstationary
        individual_models: False # do the output for sigle models (true) or multi-model ensemble (false, default)
        anomaly_type: standardized_anomaly # options: anomaly (default), standardized_anomaly and ratio
        yblock: 1 # (optional) determines how many years in block should be pooled in boostrap
        initial_conditions: False # use initial conditions for the GEV fit
        model_weighting: True # determines, if each realisation gets a weight of 1 (false) or 1/number of relisation
        event_definition: strength # options: strength (default) magnitude of the event from obs, rarity: uses return period
        # from obs and then finds the event of the same rarity in the factual climate
        region: Atl.Canada # needed for the figure title
        var_label: wind_speed # needed for axis name
        units: '' # optional parameter for the labelling
        bootstrap_seed: 501 # seed to start sequence for bootstrap (optional)
