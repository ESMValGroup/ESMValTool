# ESMValTool
#
# General instructions:
#
# (1) Copy the configuration file
#     /work/bd1179/esmvaltool_hackathon/config/config-user.yml to
#     $HOME/.esmvaltool/config-user.yml ($HOME is YOUR home directory) and modify
#     the 'output_dir' key (we recommend your scratch directory /scratch/$USER/).
# (2) Copy all diagnostics in /work/bd1179/esmvaltool_hackathon/diag_scripts/
#     to a location of your choice.
# (3) Copy this recipe to a location of your choice.
# (4) Modify the diagnostics paths in this recipe ('script: xxx.py') to point
#     to your copy of the diagnostic scripts (see (2)).
# (5) Run ESMValTool by 'esmvaltool run /path/to/your/copy/of/this/recipe.yml.'
# (6) To re-run a single diagnostic wihtout invoking ESMValTool over and over,
#     look for "To re-run this diagnostic ..." lines in the output log and
#     copy-paste the relevant command to your shell, add a '-f' flag at the end
#     and run it. Remember: if you change the recipe, you NEED to re-run the
#     entire recipe!
#
---
documentation:
  title: ICON Cloud Evaluation for multi-year simulations (Climatologies).
  description: Evaluate ICON simulations with observational products.
  authors:
    - bonnet_pauline
    - lauer_axel
    - hassler_birgit

ICON_DATA: &datasets_icon
  - {project: ICON, dataset: ICON, exp: icon-2.6.1_atm_amip_R2B5_r1v1i1p1l1f1, timerange: '19920101/20140101'}

preprocessors:

  full_climatology: &full_climatology_diag
    climate_statistics:
      period: full
    regrid:
      target_grid: 2x2
      scheme:  #unstructured_nearest
        reference: esmf_regrid.schemes:ESMFAreaWeighted
      lon_offset: false

  full_climatology_pr: 
    <<: *full_climatology_diag
    convert_units:
      units: mm day-1

  zonal_mean:
    custom_order: true
    climate_statistics:
      period: full
    extract_levels:
      levels: {cmor_table: CMIP6, coordinate: plev19}
      scheme: linear
      coordinate: air_pressure
    regrid:
      scheme: #unstructured_nearest
        reference: esmf_regrid.schemes:ESMFAreaWeighted
      target_grid: 2x2
      lon_offset: false
    zonal_statistics:
      operator: mean

diagnostics:

  # Specific instructions:
  #
  # You can copy the method 'create_timeseries_plot' to a new method
  # 'create_variable_vs_lat_plot' in the diagnostic script and
  # relevant other methods to get started.
  #
  # Remember to also add some documentation on the new plot type to the top of
  # the diagnostic file.

  plot_clt_maps:
    description: Plot clt climatology maps including reference datasets.
    variables:
      clt_icon:
        short_name: clt
        mip: Amon
        preprocessor: full_climatology
        additional_datasets: *datasets_icon
      clt_ref:
        short_name: clt
        mip: Amon
        preprocessor: full_climatology
        additional_datasets:
          - {dataset: ESACCI-CLOUD, project: OBS, type: sat,
             version: AVHRR-AMPM-fv3.0, tier: 2,
             start_year: 1992, end_year: 2014, reference_for_monitor_diags: true}
    scripts:
      plot: &plot_multi_dataset_default
        script: monitor/multi_datasets.py
        plot_folder: '{plot_dir}'
        plot_filename: '{plot_type}_{real_name}_{dataset}_{mip}'
        plots:
          map:
            common_cbar: true
            plot_kwargs_bias:
              levels: [-40., -32., -24., -16., -8., 0., 8., 16., 24., 32., 40.]
              extend: both
 
  plot_lwcre_maps:
    description: Plot lwcre climatology maps including reference datasets.
    variables:
      lwcre_icon:
        short_name: lwcre
        mip: Amon
        preprocessor: full_climatology
        derive: true
        force_derivation: true
        var_type: atm_2d_ml
        additional_datasets: *datasets_icon
      lwcre_ref:
        short_name: lwcre
        mip: Amon
        preprocessor: full_climatology
        derive: true
        additional_datasets:
          - {dataset: CERES-EBAF, project: obs4MIPs, level: L3B, version: Ed2-7, start_year: 2001, end_year: 2010, tier: 1,
             reference_for_monitor_diags: true}
    scripts:
      plot:
        <<: *plot_multi_dataset_default
        plots:
          map:
            common_cbar: true
            # plot_kwargs_bias:
            #   levels: [-0.15, -0.12, -0.09, -0.06, -0.03, 0.0, 0.03, 0.06, 0.09, 0.12, 0.15]
            #   extend: both

  plot_swcre_maps:
    description: Plot swcre climatology maps including reference datasets.
    variables:
      swcre_icon:
        short_name: swcre
        mip: Amon
        preprocessor: full_climatology
        derive: true
        force_derivation: true
        var_type: atm_2d_ml
        additional_datasets: *datasets_icon
      swcre_ref:
        short_name: swcre
        mip: Amon
        preprocessor: full_climatology
        derive: true
        additional_datasets:
          - {dataset: CERES-EBAF, project: obs4MIPs, level: L3B, version: Ed2-7, start_year: 2001, end_year: 2010, tier: 1,
             reference_for_monitor_diags: true}
    scripts:
      plot:
        <<: *plot_multi_dataset_default
        plots:
          map:
            common_cbar: true
            # plot_kwargs_bias:
            #   levels: [-0.15, -0.12, -0.09, -0.06, -0.03, 0.0, 0.03, 0.06, 0.09, 0.12, 0.15]
            #   extend: both

  plot_lwp_maps:
    description: Plot lwp climatology maps including reference datasets.
    variables:
      lwp_icon:
        short_name: lwp
        mip: Amon
        preprocessor: full_climatology
        var_type: atm_2d_ml
        additional_datasets: *datasets_icon
      lwp_ref:
        short_name: lwp
        mip: Amon
        preprocessor: full_climatology
        derive: true
        additional_datasets:
          - {project: native6, dataset: ERA5, type: reanaly, version: v1,  start_year: 1992, end_year: 2014, tier: 3, reference_for_monitor_diags: true}
    scripts:
      plot:
        <<: *plot_multi_dataset_default
        plots:
          map:
            common_cbar: true
            plot_kwargs:
              default: 
                levels: [0.00, 0.03, 0.06, 0.09, 0.12, 0.15, 0.18, 0.21, 0.24, 0.27, 0.30]
            plot_kwargs_bias:
              levels: [-0.12, -0.09, -0.06, -0.03, 0.00, 0.03, 0.06, 0.09, 0.12]
              extend: both
              fontsize: 6

  plot_clivi_maps:
    description: Plot clivi climatology maps including reference datasets.
    variables:
      clivi_icon:
        short_name: clivi
        mip: Amon
        preprocessor: full_climatology
        additional_datasets: *datasets_icon
      clivi_ref:
        short_name: clivi
        mip: Amon
        preprocessor: full_climatology
        additional_datasets: 
          - {project: native6, dataset: ERA5, type: reanaly, version: v1, start_year: 1992, end_year: 2014, tier: 3, reference_for_monitor_diags: true}
    scripts:
      plot:
        <<: *plot_multi_dataset_default
        plots:
          map:
            common_cbar: true
            plot_kwargs:
              default:
                levels: [0.00, 0.025, 0.050, 0.075, 0.100, 0.150, 0.175]
            plot_kwargs_bias:
              levels: [-0.15, -0.12, -0.09, -0.06, -0.03, 0.0, 0.03, 0.06, 0.09, 0.12, 0.15]
              extend: both

  plot_prw_maps:
    description: Plot prw climatology maps including reference datasets.
    variables:
      prw_icon:
        short_name: prw
        mip: Amon
        preprocessor: full_climatology
        additional_datasets: *datasets_icon
      prw_ref:
        short_name: prw
        mip: Amon
        preprocessor: full_climatology
        additional_datasets:
          - {dataset: ESACCI-WATERVAPOUR, project: OBS, type: sat,
             version: CDR2-L3S-05deg_fv3.1, tier: 3,
             start_year: 2003, end_year: 2017, reference_for_monitor_diags: true}
    scripts:
      plot:
        <<: *plot_multi_dataset_default
        plots:
          map:
            common_cbar: true
            plot_kwargs_bias:
              levels: [-10., -8., -6., -4., -2., 0., 2., 4., 6., 8., 10.]

  plot_pr_maps:
    description: Plot prw climatology maps including reference datasets.
    variables:
      pr_icon:
        short_name: pr
        mip: Amon
        preprocessor: full_climatology_pr
        additional_datasets: *datasets_icon
      pr_ref:
        short_name: pr
        mip: Amon
        preprocessor: full_climatology_pr
        additional_datasets:
          - {dataset: GPCP-SG, project: OBS, type: atmos, version: 2.3, tier: 2,
             start_year: 2003, end_year: 2017, reference_for_monitor_diags: true}
    scripts:
      plot:
        <<: *plot_multi_dataset_default
        plots:
          map:
            common_cbar: true
            # plot_kwargs_bias:
            #   levels: [-10., -8., -6., -4., -2., 0., 2., 4., 6., 8., 10.]
            #   extend: both

  plot_clw_profiles:
    description: Plot clw vertical profiles including reference datasets.
    variables:
      clw_icon:
        short_name: clw
        mip: Amon
        preprocessor: zonal_mean
        additional_datasets: *datasets_icon
      clw_ref:
        short_name: clw
        mip: Amon
        preprocessor: zonal_mean
        additional_datasets:
          - {dataset: CLOUDSAT-L2, project: OBS, type: sat,
             version: P1-R05-gridbox-average-noprecip,
             start_year: 2006, end_year: 2017, tier: 3, reference_for_monitor_diags: true}
    scripts:
      plot: 
        <<: *plot_multi_dataset_default
        plots:
          profile:
            common_cbar: true
            #plot_kwargs_bias:
            #  levels: [-12.0, -9.0, -6.0, -3.0, 0.0, 3.0, 6.0, 9.0, 12.0]
            #  extend: max

  plot_cli_profiles:
    description: Plot cli vertical profiles including reference datasets.
    variables:
      cli_icon:
        short_name: cli
        mip: Amon
        preprocessor: zonal_mean
        additional_datasets: *datasets_icon
      cli_ref:
        short_name: cli
        mip: Amon
        preprocessor: zonal_mean
        additional_datasets:
          - {dataset: CALIPSO-ICECLOUD, project: OBS, type: sat,
             version: 1-00, start_year: 2007, end_year: 2015, tier: 3, reference_for_monitor_diags: true}
    scripts:
      plot: 
        <<: *plot_multi_dataset_default
        plots:
          profile:
            common_cbar: true
            #plot_kwargs_bias:
            #  levels: [-12.0, -9.0, -6.0, -3.0, 0.0, 3.0, 6.0, 9.0, 12.0]
            #  extend: max

  plot_cl_profiles:
    description: Plot cl vertical profiles including reference datasets.
    variables:
      cl_icon:
        short_name: cl
        mip: Amon
        preprocessor: zonal_mean
        additional_datasets: *datasets_icon
      cl_ref:
        short_name: cl
        mip: Amon
        preprocessor: zonal_mean
        additional_datasets:
          - {project: native6, dataset: ERA5, type: reanaly, version: v1, start_year: 1992, end_year: 2014, tier: 3, reference_for_monitor_diags: true}
    scripts:
      plot: 
        <<: *plot_multi_dataset_default
        plots:
          profile:
            common_cbar: true
            #plot_kwargs_bias:
            #  levels: [-12.0, -9.0, -6.0, -3.0, 0.0, 3.0, 6.0, 9.0, 12.0]
            #  extend: max
            
            
