#!jinja2
[scheduler]
    UTC mode = True

[task parameters]
    fast = radiation_budget
    medium = ensclus, heatwaves_coldwaves

[scheduling]
   cycling mode = integer
   initial cycle point = 1
   final cycle point = 5
    [[graph]]
        R1 = """install_cold => configure => process<fast> => compare<fast>
                configure => process<medium> => compare<medium>"""
        3/P2 = compare<fast>[-P2] => configure => process<fast> => compare<fast>
        4/P3 = compare<medium>[-P3] => configure => process<medium> => compare<medium>

[runtime]
    [[root]]
{% if SITE == "jasmin" %}
        platform = lotus
{% else %}
        platform = localhost
{% endif %}
        script = rose task-run
        env-script = "eval $(rose task-env)"
        [[[environment]]]
            MODULE_NAME = {{ MODULE_NAME }}
            USER_CONFIG_DIR = ${CYLC_WORKFLOW_RUN_DIR}/etc
            USER_CONFIG_PATH = ${USER_CONFIG_DIR}/config-user.yml
            OUTPUT_DIR = ${CYLC_WORKFLOW_SHARE_DIR}/cycle/${CYLC_TASK_CYCLE_POINT}
            ESMVALCORE_DIR = ${CYLC_WORKFLOW_RUN_DIR}/lib/ESMValCore
            ESMVALTOOL_DIR = ${CYLC_WORKFLOW_RUN_DIR}/lib/ESMValTool
            PYTHONPATH_PREPEND = ${ESMVALCORE_DIR}:${ESMVALTOOL_DIR}
{% if SITE == "jasmin" %}
        [[[job]]]
            method = slurm
            execution time limit = PT15M
        [[[directives]]]
            --qos=short-serial
            --time=15:00
            --ntasks={{ MAX_PARALLEL_TASKS}}
{% endif %}

    [[install_cold]]
        [[[environment]]]
            ESMVALCORE_URL = {{ ESMVALCORE_URL }}
            ESMVALTOOL_URL = {{ ESMVALTOOL_URL }}
            SITE = {{ SITE }}

    [[configure]]
        pre-script = "mkdir -p ${USER_CONFIG_DIR}"
        [[[environment]]]
            ROSE_TASK_APP = configure
            DRS_CMIP3 = {{ DRS_CMIP3 }}
            DRS_CMIP5 = {{ DRS_CMIP5 }}
            DRS_CMIP6 = {{ DRS_CMIP6 }}
            DRS_CORDEX = {{ DRS_CORDEX }}
            DRS_OBS = {{ DRS_OBS }}
            DRS_OBS6 = {{ DRS_OBS6 }}
            DRS_ANA4MIPS = {{ DRS_ANA4MIPS }}
            DRS_NATIVE6 = {{ DRS_NATIVE6 }}
            DRS_OBS4MIPS = {{ DRS_OBS4MIPS }}
            MAX_PARALLEL_TASKS = {{ MAX_PARALLEL_TASKS }}
            ROOTPATH_CMIP3 = {{ ROOTPATH_CMIP3 }}
            ROOTPATH_CMIP5 = {{ ROOTPATH_CMIP5 }}
            ROOTPATH_CMIP6 = {{ ROOTPATH_CMIP6 }}
            ROOTPATH_CORDEX = {{ ROOTPATH_CORDEX }}
            ROOTPATH_OBS = {{ ROOTPATH_OBS }}
            ROOTPATH_OBS6 = {{ ROOTPATH_OBS6 }}
            ROOTPATH_ANA4MIPS = {{ ROOTPATH_ANA4MIPS }}
            ROOTPATH_NATIVE6 = {{ ROOTPATH_NATIVE6 }}
            ROOTPATH_OBS4MIPS = {{ ROOTPATH_OBS4MIPS }}
            ROOTPATH_RAWOBS = {{ ROOTPATH_RAWOBS }}

    [[process<fast>]]
        inherit = None, COMPUTE
        [[[environment]]]
            ROSE_TASK_APP = process
            RECIPE_NAME = "recipe_${CYLC_TASK_PARAM_fast}.yml"

    [[process<medium>]]
        inherit = None, COMPUTE
        [[[environment]]]
            ROSE_TASK_APP = process
            RECIPE_NAME = "recipe_${CYLC_TASK_PARAM_medium}.yml"

    [[compare<fast>]]
        inherit = None, COMPUTE
        [[[environment]]]
            ROSE_TASK_APP = compare
            KGO_METRIC = "${CYLC_TASK_PARAM_fast}"
            KGO_ROOT_PATH = {{ KGO_ROOT_PATH }}

    [[compare<medium>]]
        inherit = None, COMPUTE
        [[[environment]]]
            ROSE_TASK_APP = compare
            KGO_METRIC = "${CYLC_TASK_PARAM_medium}"
            KGO_ROOT_PATH = {{ KGO_ROOT_PATH }}

{% include 'site/' ~ SITE ~ '.cylc' %}
